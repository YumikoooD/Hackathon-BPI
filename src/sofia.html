<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link href="./assets/icon.png" rel="icon" type="image/x-icon">
	<link href="/css/sofia.css" rel="stylesheet">
	<title>Entretien</title>
</head>
<body>
	<div id="video" class="video"></div>
	<div id="chat" class="chat">
	</div>
</body>
<script>
	import { callChatGPT } from '../public/script/request.js';
	
	(function (window) {
		const host = "https://labs.heygen.com";
		const url =
			host +
			"/guest/streaming-embed?share=eyJxdWFsaXR5IjoiaGlnaCIsImF2YXRhck5hbWUiOiJlZjA4MDM5YTQxMzU0ZWQ1YTIwNTY1ZGI4%0D%0AOTkzNzNmMyIsInByZXZpZXdJbWciOiJodHRwczovL2ZpbGVzMi5oZXlnZW4uYWkvYXZhdGFyL3Yz%0D%0AL2VmMDgwMzlhNDEzNTRlZDVhMjA1NjVkYjg5OTM3M2YzL2Z1bGwvMi4yL3ByZXZpZXdfdGFyZ2V0%0D%0ALndlYnAiLCJuZWVkUmVtb3ZlQmFja2dyb3VuZCI6ZmFsc2UsImtub3dsZWRnZUJhc2VJZCI6IjM1%0D%0AM2EzMDRhZDNlZjQ1NmZiNzk1ZWY0MDkyZDgyMjZlIiwidXNlcm5hbWUiOiI3MjQ5ZmU0MTdiNGQ0%0D%0AODM3ODVkMmZlNmQ2MzBhYjdiZCJ9&inIFrame=1";

			// Initialize SpeechRecognition
			let recognition;
		if ('SpeechRecognition' in window || 'webkitSpeechRecognition' in window) {
			recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
			recognition.continuous = true;
			recognition.interimResults = true;
			recognition.lang = 'fr-FR';
		} else {
			alert("Speech Recognition API is not supported in your browser.");
			return ;
		}

		const clientWidth = document.body.clientWidth;

		// Create the main wrapper div
		const wrapDiv = document.createElement("div");
		wrapDiv.id = "heygen-streaming-embed";

		// Create the container for the iframe
		const container = document.createElement("div");
		container.id = "heygen-streaming-container";

		// Add custom styles
		const stylesheet = document.createElement("style");
		stylesheet.innerHTML = `
			#heygen-streaming-embed {
				margin: 100px auto;
				width: 80%;
				height: 80%;
				border-radius: 5%;
				border: none;
				box-shadow: none;
				transition: all linear 0.1s;
				overflow: hidden;
				opacity: 1;
				visibility: visible;
			}

			#heygen-streaming-embed.show {
				opacity: 1;
				visibility: visible;
			}

			#heygen-streaming-embed.expand {
				width: 40vw;
				height: 80vh;
			}

			#heygen-streaming-container {
				width: 100%;
				height: 100%;
			}

			#heygen-streaming-container iframe {
				width: 100%;
				height: 100%;
				border: 0;
			}
		`;

		// Create the iframe element
		const iframe = document.createElement("iframe");
		iframe.allowFullscreen = false;
		iframe.title = "Streaming Embed";
		iframe.role = "dialog";
		iframe.allow = "microphone";
		iframe.src = url;

		let visible = false;
		let initial = false;

		// Listen for messages from the iframe
		let fullTranscript = "";
		window.addEventListener("message", (e) => {
			if (e.origin === host && e.data && e.data.type === "streaming-embed") {
				switch (e.data.action) {
					case "init":
						initial = true;
						wrapDiv.classList.toggle("show", initial);
						break;
					case "show":
						visible = true;
						recognition.start();
						wrapDiv.classList.toggle("expand", visible);
						break;
					case "hide":
						visible = false;
						recognition.stop();
						// Store the full transcript in localStorage
						const cleanedTranscript = fullTranscript.trim(); // Remove trailing spaces
						localStorage.setItem("data", JSON.stringify(cleanedTranscript));
						wrapDiv.classList.toggle("expand", visible);
						sendPrompt();
						break;
				}
			}
		});

		async function sendPrompt() {
			const prompt = `Voici une discussion longue et non structurée entre un chargé d'affaires BPI nommé Sofia et un entrepreneur. Cette discussion contient des informations importantes sur le profil de l'entrepreneur et son entreprise. Ignore les informations superflues, répétées ou non pertinentes, et extrais uniquement les informations nécessaires pour compléter les champs suivants dans un fichier JSON structuré.
				Le JSON doit être divisé en deux blocs :
				1. "entrepreneur" : Inclure uniquement les données pertinentes au profil personnel de l'entrepreneur.
				2. "entreprise" : Inclure uniquement les données pertinentes à l'entreprise.

				Les champs à extraire doivent inclure (mais ne sont pas limités à) :
				- **Pour le bloc "entrepreneur"** :
				- "nom" : Nom complet de l'entrepreneur.
				- "age" : Âge de l'entrepreneur (si mentionné ou déductible).
				- "intention" : Intention de l'entrepreneur (ex. gestion, création, cession, reprise, etc.).
				- "expertise" : Expertise ou secteur de compétence de l'entrepreneur.
				- "biographie" : Une brève description de l'entrepreneur, basée sur les informations données.

				- **Pour le bloc "entreprise"** :
				- "nom" : Nom de l'entreprise.
				- "secteur" : Secteur d'activité principal de l'entreprise.
				- "status" : Statut actuel de l'entreprise (par ex. active, en démarrage, en cessation, etc.).
				- "fondation" : Année de fondation de l'entreprise (si mentionnée).
				- "description" : Une brève description de l'entreprise, ses activités principales ou sa mission.

				Fournis le résultat final sous forme de JSON structuré, trié par ordre d'importance :

				Si une information n’est pas disponible ou déductible, laisse le champ vide ou ne l’inclus pas dans la réponse.

				Texte de la discussion :
				` + data;

			const data = await callChatGPT(prompt);
			if (data) {
				// Save to localStorage for the result page
				localStorage.setItem("chatGPTResult", JSON.stringify(data));
				window.location.href = "result.html"; // Redirect to result page
			} else {
				alert("Failed to fetch data from ChatGPT");
			}
		}


		// Handle speech recognition results
		recognition.onresult = function(event) {
			let finalTranscript = '';

			for (let i = event.resultIndex; i < event.results.length; i++) {
				if (event.results[i].isFinal)
					finalTranscript += event.results[i][0].transcript;
			}

			// Check if final transcript exists
			if (finalTranscript) {
				fullTranscript += finalTranscript + ". ";
				appendBubble(finalTranscript);
			}
		};

		// Append bubble in chat
		function appendBubble(transcript) {
			const chat = document.getElementById("chat");
			const bubble = document.createElement("p");
			bubble.textContent = transcript;
			bubble.className = "bubble";
			chat.appendChild(bubble);
		}

		// Handle speech recognition error
		recognition.onerror = function(event) {
			console.error("Speech Recognition Error:", event.error);
		};

		// Append elements to the DOM
		container.appendChild(iframe);
		wrapDiv.appendChild(stylesheet);
		wrapDiv.appendChild(container);
		const videoDiv = document.getElementById("video");
		videoDiv.appendChild(wrapDiv);
	})(globalThis);
</script>
</html>
